From 9813a75dbb6ee68c04a4157724b6a0f86ffe2a4f Mon Sep 17 00:00:00 2001
From: Jan Pavlinec <jan.pavlinec@nic.cz>
Date: Wed, 31 Oct 2018 12:57:34 +0100
Subject: [PATCH] git: update to version 2.19.1 (security fix)

CVE-2018-17456 - https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-17456

Issue https://gitlab.labs.nic.cz/turris/turris-os-packages/issues/242
---
 net/git/Makefile                                   | 18 +++++-------
 .../patches/100-configure_for_crosscompiling.patch | 32 ++++++++++++++++++++++
 net/git/patches/200-imapsend_without_curl.patch    | 11 ++++++++
 3 files changed, 50 insertions(+), 11 deletions(-)
 create mode 100644 net/git/patches/100-configure_for_crosscompiling.patch
 create mode 100644 net/git/patches/200-imapsend_without_curl.patch

diff --git a/net/git/Makefile b/net/git/Makefile
index 3cef833..844a5d0 100644
--- a/net/git/Makefile
+++ b/net/git/Makefile
@@ -8,12 +8,12 @@
 include $(TOPDIR)/rules.mk
 
 PKG_NAME:=git
-PKG_VERSION:=2.17.1
+PKG_VERSION:=2.19.1
 PKG_RELEASE:=1
 
 PKG_SOURCE:=$(PKG_NAME)-$(PKG_VERSION).tar.xz
 PKG_SOURCE_URL:=@KERNEL/software/scm/git/
-PKG_MD5SUM:=79136e7aa83abae4d8a25c8111f113d3c5a63aeb5fd93cc72c26d49c6d5ba65e
+PKG_MD5SUM:=345056aa9b8084280b1b9fe1374d232dec05a34e8849028a20bfdb56e920dbb5
 
 PKG_INSTALL:=1
 PKG_BUILD_PARALLEL:=1
@@ -44,7 +44,7 @@ endef
 
 define Package/git-http
 $(call Package/git/Default)
-  DEPENDS+= +git +libcurl +ca-certificates
+  DEPENDS+= +git +libcurl
   TITLE:=Git HTTP commands
 endef
 
@@ -106,14 +106,11 @@ define Build/Compile
 endef
 
 define Package/git/install
-	$(INSTALL_DIR) $(1)/usr/bin
-	$(CP) $(PKG_INSTALL_DIR)/usr/bin/git $(1)/usr/bin
 	$(RM) $(PKG_INSTALL_DIR)/usr/bin/git-cvsserver
+	$(RM) $(PKG_INSTALL_DIR)/usr/bin/git-shell
+	$(INSTALL_DIR) $(1)/usr/bin
 	$(CP) $(PKG_INSTALL_DIR)/usr/bin/git-* $(1)/usr/bin
 	$(INSTALL_DIR) $(1)/usr/lib/git-core
-	ln $(1)/usr/bin/git $(1)/usr/lib/git-core/git
-	ln $(1)/usr/bin/git-shell $(1)/usr/lib/git-core/git-shell
-	ln $(1)/usr/bin/git-upload-pack $(1)/usr/lib/git-core/git-upload-pack
 	$(INSTALL_DIR) $(1)/usr/share/git-core/templates
 	( cd $(PKG_INSTALL_DIR); $(TAR) \
 		--exclude=usr/lib/git-core/git-http-backend \
@@ -122,13 +119,12 @@ define Package/git/install
 		--exclude=usr/lib/git-core/git-remote-ftps \
 		--exclude=usr/lib/git-core/git-remote-http \
 		--exclude=usr/lib/git-core/git-remote-https \
-		--exclude=usr/lib/git-core/git \
-		--exclude=usr/lib/git-core/git-shell \
-		--exclude=usr/lib/git-core/git-upload-pack \
 		-cf - \
 		usr/lib/git-core \
 		usr/share/git-core/templates \
 	) | ( cd $(1); $(TAR) -xf - )
+	ln $(1)/usr/lib/git-core/git $(1)/usr/bin/git
+	ln $(1)/usr/lib/git-core/git-shell $(1)/usr/bin/git-shell
 endef
 
 define Package/git-http/install
diff --git a/net/git/patches/100-configure_for_crosscompiling.patch b/net/git/patches/100-configure_for_crosscompiling.patch
new file mode 100644
index 0000000..07796e6
--- /dev/null
+++ b/net/git/patches/100-configure_for_crosscompiling.patch
@@ -0,0 +1,32 @@
+--- a/configure.ac
++++ b/configure.ac
+@@ -929,7 +929,8 @@ AC_RUN_IFELSE(
+ 		FILE *f = fopen(".", "r");
+ 		return f != NULL;]])],
+ 	[ac_cv_fread_reads_directories=no],
+-	[ac_cv_fread_reads_directories=yes])
++	[ac_cv_fread_reads_directories=yes],
++	[ac_cv_fread_reads_directories=no])
+ ])
+ if test $ac_cv_fread_reads_directories = yes; then
+ 	FREAD_READS_DIRECTORIES=UnfortunatelyYes
+@@ -963,7 +964,8 @@ AC_RUN_IFELSE(
+ 		  if (snprintf(buf, 3, "%s", "12345") != 5
+ 		      || strcmp(buf, "12")) return 1]])],
+ 	[ac_cv_snprintf_returns_bogus=no],
+-	[ac_cv_snprintf_returns_bogus=yes])
++	[ac_cv_snprintf_returns_bogus=yes],
++	[ac_cv_snprintf_returns_bogus=no])
+ ])
+ if test $ac_cv_snprintf_returns_bogus = yes; then
+ 	SNPRINTF_RETURNS_BOGUS=UnfortunatelyYes
+@@ -986,7 +988,8 @@ yippeeyeswehaveit
+ #endif
+ ]),
+ 	[ac_cv_sane_mode_bits=yes],
+-	[ac_cv_sane_mode_bits=no])
++	[ac_cv_sane_mode_bits=no],
++	[ac_cv_sane_mode_bits=yes])
+ ])
+ if test $ac_cv_sane_mode_bits = yes; then
+ 	NEEDS_MODE_TRANSLATION=
diff --git a/net/git/patches/200-imapsend_without_curl.patch b/net/git/patches/200-imapsend_without_curl.patch
new file mode 100644
index 0000000..75268a4
--- /dev/null
+++ b/net/git/patches/200-imapsend_without_curl.patch
@@ -0,0 +1,11 @@
+--- a/Makefile
++++ b/Makefile
+@@ -1312,7 +1312,7 @@ else
+ 	endif
+ 	curl_check := $(shell (echo 072200; $(CURL_CONFIG) --vernum | sed -e '/^70[BC]/s/^/0/') 2>/dev/null | sort -r | sed -ne 2p)
+ 	ifeq "$(curl_check)" "072200"
+-		USE_CURL_FOR_IMAP_SEND = YesPlease
++#		USE_CURL_FOR_IMAP_SEND = YesPlease
+ 	endif
+ 	ifdef USE_CURL_FOR_IMAP_SEND
+ 		BASIC_CFLAGS += -DUSE_CURL_FOR_IMAP_SEND
-- 
2.7.4

