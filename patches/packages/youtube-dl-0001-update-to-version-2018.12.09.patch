From 5b79d4edca86fc1776e12cf295332ae60cdfa19a Mon Sep 17 00:00:00 2001
From: Josef Schlehofer <josef.schlehofer@nic.cz>
Date: Thu, 13 Dec 2018 17:47:41 +0100
Subject: [PATCH] youtube-dl: update to version 2018.12.09

---
 multimedia/youtube-dl/Makefile                | 22 +++++++++++++------
 .../youtube-dl/patches/dont-use-pandoc.patch  | 21 ++++++++++++++++++
 2 files changed, 36 insertions(+), 7 deletions(-)
 create mode 100644 multimedia/youtube-dl/patches/dont-use-pandoc.patch

diff --git a/multimedia/youtube-dl/Makefile b/multimedia/youtube-dl/Makefile
index eaa43393d..30a9a3aaa 100644
--- a/multimedia/youtube-dl/Makefile
+++ b/multimedia/youtube-dl/Makefile
@@ -8,18 +8,19 @@
 include $(TOPDIR)/rules.mk
 
 PKG_NAME:=youtube-dl
-PKG_VERSION:=2016.05.16
+PKG_VERSION:=2018.12.09
 PKG_RELEASE:=1
 
 PKG_SOURCE:=$(PKG_NAME)-$(PKG_VERSION).tar.gz
-PKG_SOURCE_URL:=http://youtube-dl.org/downloads/$(PKG_VERSION)/
-PKG_MD5SUM:=f50b53b9938eeb43a2466e451e71f474
-PKG_BUILD_DIR:=$(BUILD_DIR)/$(PKG_NAME)
+PKG_SOURCE_URL:=https://codeload.github.com/rg3/youtube-dl/tar.gz/$(PKG_VERSION)?
+PKG_HASH:=f277dee39adcf1fa19a14846eebc1e2c3749dd245e11d51783fa5ea366f34bff
+PKG_BUILD_DIR:=$(BUILD_DIR)/$(PKG_NAME)-$(PKG_VERSION)
 
 PKG_LICENSE:=Unlicense
 PKG_LICENSE_FILES:=LICENSE
 PKG_MAINTAINER:=Adrian Panella <ianchi74@outlook.com>
 
+PKG_BUILD_DEPENDS:=python/host zip/host
 
 include $(INCLUDE_DIR)/package.mk
 
@@ -32,14 +33,21 @@ define Package/youtube-dl
 endef
 
 define Package/youtube-dl/description
-  youtube-dl is a small command-line program to download videos 
-  from YouTube.com and a few more sites. 
+  youtube-dl is a small command-line program to download videos
+  from YouTube.com and a few more sites.
   It requires the Python interpreter.
 endef
 
 define Package/youtube-dl/install
 	$(INSTALL_DIR) $(1)/usr/bin
-	$(INSTALL_BIN) $(PKG_BUILD_DIR)/youtube-dl $(1)/usr/bin/
+
+	python -m compileall $(PKG_BUILD_DIR)/youtube_dl/
+	cd $(PKG_BUILD_DIR) && zip --quiet youtube-dl-c.zip youtube_dl/*.pyc youtube_dl/*/*.pyc
+	cd $(PKG_BUILD_DIR) && zip --quiet --junk-paths youtube-dl-c.zip youtube_dl/__main__.pyc
+	echo '#!/usr/bin/env python' > $(PKG_BUILD_DIR)/youtube-dl-c
+	cat $(PKG_BUILD_DIR)/youtube-dl-c.zip >> $(PKG_BUILD_DIR)/youtube-dl-c
+
+	$(INSTALL_BIN) -T $(PKG_BUILD_DIR)/youtube-dl-c $(1)/usr/bin/youtube-dl
 endef
 
 $(eval $(call BuildPackage,youtube-dl))
diff --git a/multimedia/youtube-dl/patches/dont-use-pandoc.patch b/multimedia/youtube-dl/patches/dont-use-pandoc.patch
new file mode 100644
index 000000000..51b3dd588
--- /dev/null
+++ b/multimedia/youtube-dl/patches/dont-use-pandoc.patch
@@ -0,0 +1,21 @@
+diff --git a/Makefile b/Makefile
+index 4a62f44..fee93e8 100644
+--- a/Makefile
++++ b/Makefile
+@@ -85,12 +85,12 @@ supportedsites:
+ 	$(PYTHON) devscripts/make_supportedsites.py docs/supportedsites.md
+ 
+ README.txt: README.md
+-	pandoc -f $(MARKDOWN) -t plain README.md -o README.txt
++#	pandoc -f $(MARKDOWN) -t plain README.md -o README.txt
+ 
+ youtube-dl.1: README.md
+-	$(PYTHON) devscripts/prepare_manpage.py youtube-dl.1.temp.md
+-	pandoc -s -f $(MARKDOWN) -t man youtube-dl.1.temp.md -o youtube-dl.1
+-	rm -f youtube-dl.1.temp.md
++#	$(PYTHON) devscripts/prepare_manpage.py youtube-dl.1.temp.md
++#	pandoc -s -f $(MARKDOWN) -t man youtube-dl.1.temp.md -o youtube-dl.1
++#	rm -f youtube-dl.1.temp.md
+ 
+ youtube-dl.bash-completion: youtube_dl/*.py youtube_dl/*/*.py devscripts/bash-completion.in
+ 	$(PYTHON) devscripts/bash-completion.py
-- 
2.17.1

