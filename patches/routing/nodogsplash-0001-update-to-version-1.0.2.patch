From 982d31975e79056f796e55ca92acce6ada09d5a2 Mon Sep 17 00:00:00 2001
From: Jan Pavlinec <jan.pavlinec@nic.cz>
Date: Wed, 15 Aug 2018 15:40:26 +0200
Subject: [PATCH] nodogsplash: update to version 1.0.2

---
 nodogsplash/Makefile                      |  6 ++---
 nodogsplash/files/nodogsplash.config      | 15 +++++++++--
 nodogsplash/files/nodogsplash.init        | 18 +++++++++++++
 nodogsplash/patches/100-musl-compat.patch | 43 -------------------------------
 4 files changed, 34 insertions(+), 48 deletions(-)
 delete mode 100644 nodogsplash/patches/100-musl-compat.patch

diff --git a/nodogsplash/Makefile b/nodogsplash/Makefile
index 76a5e14..88ada7b 100644
--- a/nodogsplash/Makefile
+++ b/nodogsplash/Makefile
@@ -9,13 +9,13 @@ include $(TOPDIR)/rules.mk
 
 PKG_NAME:=nodogsplash
 PKG_FIXUP:=autoreconf
-PKG_VERSION:=1.0.0
+PKG_VERSION:=1.0.2
 PKG_RELEASE:=1
 
 PKG_BUILD_DIR:=$(BUILD_DIR)/$(PKG_NAME)-$(PKG_VERSION)/
 PKG_SOURCE:=$(PKG_NAME)-$(PKG_VERSION).tar.gz
-PKG_SOURCE_URL:=git://github.com/nodogsplash/nodogsplash.git
-PKG_SOURCE_VERSION:=v1.0.0
+PKG_SOURCE_URL:=https://github.com/nodogsplash/nodogsplash.git
+PKG_SOURCE_VERSION:=9ef7d5fc16351585baf65877776d19cf85bf3031
 PKG_SOURCE_SUBDIR:=$(PKG_NAME)-$(PKG_VERSION)
 PKG_BUILD_PARALLEL:=1
 PKG_LICENSE:=GPL-2.0+
diff --git a/nodogsplash/files/nodogsplash.config b/nodogsplash/files/nodogsplash.config
index 1825a99..9626b80 100644
--- a/nodogsplash/files/nodogsplash.config
+++ b/nodogsplash/files/nodogsplash.config
@@ -1,4 +1,7 @@
 
+# The options available here are an adaptation of the settings used in nodogsplash.conf.
+# See https://github.com/nodogsplash/nodogsplash/blob/master/resources/nodogsplash.conf
+
 config nodogsplash
   # Set to 1 to enable nodogsplash
   option enabled 0
@@ -10,7 +13,7 @@ config nodogsplash
   option network 'lan'
   option gatewayname 'OpenWrt Nodogsplash'
   option maxclients '250'
-  option idletimeout '1200'
+  option clientidletimeout '1200'
 
   # Your router may have several interfaces, and you
   # probably want to keep them private from the network/gatewayinterface.
@@ -39,4 +42,12 @@ config nodogsplash
   list users_to_router 'allow tcp port 80'
   list users_to_router 'allow tcp port 443'
 
-  # See https://github.com/nodogsplash for a full list of available options.
+  # MAC addresses that are / are not allowed to access the splash page
+  # Value is either 'allow' or 'block'. The allowedmac or blockedmac list is used.
+  #option macmechanism 'allow'
+  #list allowedmac '00:00:C0:01:D0:0D'
+  #list allowedmac '00:00:C0:01:D0:1D'
+  #list blockedmac '00:00:C0:01:D0:2D'
+
+  #MAC addresses that do not need to authenticate
+  #list trustedmac '00:00:C0:01:D0:1D'
diff --git a/nodogsplash/files/nodogsplash.init b/nodogsplash/files/nodogsplash.init
index f3df6a1..85bcfcc 100755
--- a/nodogsplash/files/nodogsplash.init
+++ b/nodogsplash/files/nodogsplash.init
@@ -119,6 +119,22 @@ setup_firewall() {
   done
 }
 
+wait_for_interface()
+{
+  local ifname="$1"
+  local timeout=10
+  for i in $(seq $timeout); do
+    if [ $(ip -4 addr show dev $ifname 2> /dev/null | grep -c inet) -ne 0 ]; then
+      break
+    fi
+    sleep 1
+    if [ $i == $timeout ] ; then
+      nolog error "$ifname not detected, NoDogSplash not starting."
+      exit 1
+    fi
+  done
+}
+
 generate_uci_config() {
   local cfg="$1"
   local val
@@ -161,6 +177,8 @@ generate_uci_config() {
       return 1
   fi
 
+  wait_for_interface "$ifname"
+
   echo "GatewayInterface $ifname" >> $CONFIGFILE
 
   append_config_option "$CONFIGFILE" "$cfg" gatewayname
diff --git a/nodogsplash/patches/100-musl-compat.patch b/nodogsplash/patches/100-musl-compat.patch
deleted file mode 100644
index bb186bc..0000000
--- a/nodogsplash/patches/100-musl-compat.patch
+++ /dev/null
@@ -1,43 +0,0 @@
---- a/src/client_list.c
-+++ b/src/client_list.c
-@@ -36,7 +36,7 @@
- #include <pthread.h>
- #include <sys/wait.h>
- #include <sys/types.h>
--#include <sys/unistd.h>
-+#include <unistd.h>
- 
- #include <string.h>
- 
---- a/src/firewall.c
-+++ b/src/firewall.c
-@@ -37,7 +37,7 @@
- #include <pthread.h>
- #include <sys/wait.h>
- #include <sys/types.h>
--#include <sys/unistd.h>
-+#include <unistd.h>
- 
- #include <string.h>
- 
---- a/src/util.c
-+++ b/src/util.c
-@@ -38,7 +38,7 @@
- #include <pthread.h>
- #include <sys/wait.h>
- #include <sys/types.h>
--#include <sys/unistd.h>
-+#include <unistd.h>
- #include <netinet/in.h>
- #include <sys/ioctl.h>
- #include <arpa/inet.h>
---- a/libhttpd/protocol.c
-+++ b/libhttpd/protocol.c
-@@ -25,6 +25,7 @@
- #include <sys/types.h>
- #include <sys/stat.h>
- #include <time.h>
-+#include <fcntl.h>
- 
- #if defined(_WIN32) 
- #else
-- 
2.7.4

